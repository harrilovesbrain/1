function hs_plotMUA(mouseName)
% ================================================================
%  hs_plotMUA(mouseName)
%
%  LEC MUA depth profile (Yuta-style, using XML geometry)
%  - Uses channels 128â€“255 from geometry XML (LEC shanks)
%  - Uses all timestamps (NO EMG gating)
%  - 500â€“5000 Hz MUA power is assumed already in MUA.data
%  - Keeps original smooth shape, adds only fine spikiness
%  - Smaller SEM shadow
%
%  Example:
%     hs_plotMUA('HJ017')
% ================================================================

% ---------- locate all MUA files ----------
rootDir  = fullfile('Z:\Buzsakilabspace\LabShare\JunH\Photometry', mouseName);
sessions = dir(fullfile(rootDir,'**','*.MUA.mat'));
if isempty(sessions)
    error('No MUA files found for %s.', mouseName);
end

% ---------- load XML geometry ONCE ----------
persistent lecCh lecDepth
if isempty(lecCh) || isempty(lecDepth)
    xmlFiles = dir(fullfile(rootDir,'**','*.xml'));
    if isempty(xmlFiles)
        error('No XML geometry found under %s', rootDir);
    end

    xmlPath = fullfile(xmlFiles(1).folder, xmlFiles(1).name);
    S = readstruct(xmlPath);
    if ~isfield(S,'channelCoordinates')
        error('XML %s has no channelCoordinates field.', xmlPath);
    end

    ch  = [];
    dep = [];
    for iSh = 1:numel(S.channelCoordinates.shank)
        CC = S.channelCoordinates.shank(iSh).channelCoordinate;
        for k = 1:numel(CC)
            ch(end+1)  = CC(k).channel;   %#ok<AGROW>
            dep(end+1) = CC(k).y;         %#ok<AGROW>  % depth in Âµm
        end
    end

    % Use LEC range: hardware channels 128â€“255
    lecMask  = (ch >= 128) & (ch <= 255);
    lecCh    = ch(lecMask);
    lecDepth = dep(lecMask);

    % sort by depth (superficialâ†’deep)
    [lecDepth, idx] = sort(lecDepth(:));
    lecCh           = lecCh(idx);

    % shift so deepest contact ~1280 Âµm (XML max is 1260)
    lecDepth = lecDepth + (1280 - max(lecDepth));
    fprintf('ðŸ“¡ Using geometry from %s (LEC 128â€“255, %d chans)\n', ...
            xmlPath, numel(lecCh));
end

% ---------- depth grid for interpolation: FULL LEC RANGE ----------
fullDepth = linspace(min(lecDepth), max(lecDepth), 256);

% ---------- accumulate profiles ----------
allProfiles = [];
nSessions   = 0;

for i = 1:numel(sessions)
    muaPath = fullfile(sessions(i).folder, sessions(i).name);
    S = load(muaPath);
    if ~isfield(S,'MUA') || ~isfield(S.MUA,'data')
        fprintf('âš ï¸  Invalid MUA in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    MUA = S.MUA.data;          % [time Ã— channels]
    [~, nCh] = size(MUA);

    % columns corresponding to LEC hardware channels 128â€“255
    % (hardware channels are 0-based; +1 to convert to MATLAB columns)
    lecCols = lecCh + 1;
    lecCols = lecCols(lecCols >= 1 & lecCols <= nCh);
    if numel(lecCols) < 10
        fprintf('âš ï¸  Not enough LEC channels in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    % ---------- channel-wise MUA power (no EMG gating) ----------
    power = mean(abs(MUA(:, lecCols)), 1);   % 1 Ã— nLEC
    if all(power == 0)
        fprintf('âš ï¸  Zero power in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    % normalize across depth
    power = power / max(power);

    % ============================================================
    %   Yuta-style SPIKINESS while preserving original shape
    % ============================================================

    % base smooth shape (what you liked before)
    baseSmooth = smoothdata(power, 'gaussian', 7);   % main envelope

    % very slow trend (remove only ultra-slow drift)
    slowTrend  = smoothdata(baseSmooth, 'gaussian', 21);

    % high-frequency detail (zero-mean bumps)
    hiDetail   = baseSmooth - slowTrend;

    % add small bumps on top of base shape
    spikeGain  = 0.6;        % <--- main "spikiness" knob (0.4â€“0.8)
    powerSpiky = baseSmooth + spikeGain * hiDetail;

    % keep everything non-negative
    powerSpiky = max(powerSpiky, 0);

    % mild contrast stretch (does NOT change ordering/shape much)
    powerSpiky = powerSpiky .^ 0.9;

    % re-normalize per session
    powerSpiky = powerSpiky / max(powerSpiky);

    % ---------- map to real depths using XML ----------
    hwCh = lecCols - 1;                  % back to hardware channel IDs
    [~, loc] = ismember(hwCh, lecCh);    % indices into lecCh/lecDepth
    valid = loc > 0;

    chanDepth = lecDepth(loc(valid));
    powUsed   = powerSpiky(valid);

    % make sure depths are strictly increasing for interp1
    [chanDepth, order] = sort(chanDepth);
    powUsed = powUsed(order);

    [chanDepth, uIdx] = unique(chanDepth);
    powUsed           = powUsed(uIdx);

    % interpolate to common depth grid
    prof = interp1(chanDepth, powUsed, fullDepth, 'pchip', 'extrap');

    % store
    nSessions = nSessions + 1;
    allProfiles(nSessions, :) = prof;
    fprintf('   â€¢ %s (%d/%d) â†’ included\n', sessions(i).name, nSessions, numel(sessions));
end

if nSessions == 0
    warning('No valid sessions after processing.');
    return;
end

% ---------- average & SEM ----------
meanMUA = mean(allProfiles, 1);
semMUA  = std(allProfiles, [], 1) / sqrt(nSessions);

% normalize final profile (peak = 1)
meanMUA = meanMUA / max(meanMUA);
semMUA  = semMUA / max(meanMUA);

% ---------- plot ----------
figure('Color','w','Position',[320 180 420 640]); hold on;

% guide lines every 100 Âµm over full LEC range
yMin = floor(min(fullDepth)/100)*100;
yMax = ceil(max(fullDepth)/100)*100;
for y = yMin:100:yMax
    plot([0 1.05], [y y], 'Color', [0.85 0.85 0.85], 'LineWidth', 0.5);
end

% SEM shadow (small)
semScale = 0.6;  % shrink the width of the gray band
fill([meanMUA - semScale*semMUA, fliplr(meanMUA + semScale*semMUA)], ...
     [fullDepth, fliplr(fullDepth)], [0.7 0.7 0.7], ...
     'EdgeColor', 'none', 'FaceAlpha', 0.35);

% bold mean trace (same global shape, now with fine bumps)
plot(meanMUA, fullDepth, 'k', 'LineWidth', 3);

set(gca, 'YDir', 'reverse', 'Box', 'off', 'TickDir', 'out', ...
         'FontSize', 12, 'LineWidth', 1.2);
xlabel('Normalized MUA power (500â€“5000 Hz)');
ylabel('Depth (Âµm)');
title(sprintf('LEC Depth Profile â€” %s (n = %d)', mouseName, nSessions), ...
      'FontWeight', 'normal');

xlim([0 1.05]);
ylim([min(fullDepth) max(fullDepth)]);
set(gca, 'Layer', 'top');

fprintf('\nâœ… Finished hs_plotMUA for %s (%d sessions)\n', mouseName, nSessions);
end
